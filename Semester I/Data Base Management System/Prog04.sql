-- Creating BRANCH table
CREATE TABLE BRANCH (
    IFSC VARCHAR2(11) PRIMARY KEY,
    BRANCH_NAME VARCHAR2(100) UNIQUE,
    BRANCH_CITY VARCHAR2(50),
    ASSETS REAL
);

-- Creating ACCOUNT table 
CREATE TABLE ACCOUNT (
    ACCNO INT PRIMARY KEY,
    IFSC VARCHAR2(11),
    BALANCE REAL,
    FOREIGN KEY (IFSC) REFERENCES BRANCH(IFSC)
);

-- Creating DEPOSITOR table 
CREATE TABLE DEPOSITOR (
    ACCNO INT,
    CUSTOMER_NAME VARCHAR2(100),
    PRIMARY KEY (ACCNO, CUSTOMER_NAME),
    FOREIGN KEY (ACCNO) REFERENCES ACCOUNT(ACCNO)
);

-- Creating CUSTOMER table
CREATE TABLE CUSTOMER (
    ACCNO INT PRIMARY KEY,
    CUSTOMER_NAME VARCHAR2(100),
    CUSTOMER_STREET VARCHAR2(100),
    CUSTOMER_CITY VARCHAR2(50),
    FOREIGN KEY (ACCNO) REFERENCES ACCOUNT(ACCNO)
);

-- Creating LOAN table
CREATE TABLE LOAN (
    LOAN_NO INT PRIMARY KEY,
    IFSC VARCHAR2(11),
    AMOUNT REAL,
    FOREIGN KEY (IFSC) REFERENCES BRANCH(IFSC)
);

-- Creating BORROWER table
CREATE TABLE BORROWER (
    LOAN_NO INT,
    CUSTOMER_NAME VARCHAR2(100),
    PRIMARY KEY (LOAN_NO, CUSTOMER_NAME),
    FOREIGN KEY (LOAN_NO) REFERENCES LOAN(LOAN_NO)
);

-- Insert data into BRANCH table
INSERT INTO BRANCH VALUES (
    'IFSC001',
    'Main Branch',
    'New York',
    5000000
);

INSERT INTO BRANCH VALUES (
    'IFSC002',
    'City Branch',
    'Chicago',
    2000000
);

INSERT INTO BRANCH VALUES (
    'IFSC003',
    'Suburban Branch',
    'San Francisco',
    1500000
);

INSERT INTO BRANCH VALUES (
    'IFSC004',
    'Downtown Branch',
    'Boston',
    3000000
);

INSERT INTO BRANCH VALUES (
    'IFSC005',
    'Rural Branch',
    'Austin',
    1000000
);

-- Insert data into ACCOUNT table
INSERT INTO ACCOUNT VALUES (
    101,
    'IFSC001',
    5000
);

INSERT INTO ACCOUNT VALUES (
    102,
    'IFSC002',
    1500
);

INSERT INTO ACCOUNT VALUES (
    103,
    'IFSC001',
    3000
);

INSERT INTO ACCOUNT VALUES (
    104,
    'IFSC003',
    2000
);

INSERT INTO ACCOUNT VALUES (
    105,
    'IFSC001',
    2500
);

-- Insert data into DEPOSITOR table
INSERT INTO DEPOSITOR VALUES (
    101,
    'John Doe'
);

INSERT INTO DEPOSITOR VALUES (
    102,
    'Jane Smith'
);

INSERT INTO DEPOSITOR VALUES (
    103,
    'John Doe'
);

INSERT INTO DEPOSITOR VALUES (
    104,
    'Alice Johnson'
);

INSERT INTO DEPOSITOR VALUES (
    105,
    'Robert Brown'
);

-- Insert data into CUSTOMER table
INSERT INTO CUSTOMER VALUES (
    101,
    'John Doe',
    '5th Avenue',
    'New York'
);

INSERT INTO CUSTOMER VALUES (
    102,
    'Jane Smith',
    'Lake Shore Drive',
    'Chicago'
);

INSERT INTO CUSTOMER VALUES (
    103,
    'John Doe',
    '5th Avenue',
    'New York'
);

INSERT INTO CUSTOMER VALUES (
    104,
    'Alice Johnson',
    'Market Street',
    'San Francisco'
);

INSERT INTO CUSTOMER VALUES (
    105,
    'Robert Brown',
    '6th Avenue',
    'New York'
);

-- Insert data into LOAN table
INSERT INTO LOAN VALUES (
    201,
    'IFSC001',
    10000
);

INSERT INTO LOAN VALUES (
    202,
    'IFSC002',
    5000
);

INSERT INTO LOAN VALUES (
    203,
    'IFSC001',
    8000
);

INSERT INTO LOAN VALUES (
    204,
    'IFSC003',
    12000
);

INSERT INTO LOAN VALUES (
    205,
    'IFSC004',
    6000
);

-- Insert data into BORROWER table
INSERT INTO BORROWER VALUES (
    201,
    'John Doe'
);

INSERT INTO BORROWER VALUES (
    202,
    'Jane Smith'
);

INSERT INTO BORROWER VALUES (
    203,
    'John Doe'
);

INSERT INTO BORROWER VALUES (
    204,
    'Alice Johnson'
);

INSERT INTO BORROWER VALUES (
    205,
    'Robert Brown'
);

SELECT
    D.CUSTOMER_NAME
FROM
    DEPOSITOR D
    JOIN ACCOUNT A
    ON D.ACCNO = A.ACCNO
    JOIN BRANCH B
    ON A.IFSC = B.IFSC
WHERE
    B.BRANCH_NAME = 'Main Branch'
GROUP BY
    D.CUSTOMER_NAME
HAVING
    COUNT(A.ACCNO) >= 2;


SELECT
    C.CUSTOMER_NAME
FROM
    CUSTOMER C
    JOIN ACCOUNT A
    ON C.ACCNO = A.ACCNO
    JOIN BRANCH B
    ON A.IFSC = B.IFSC
WHERE
    B.BRANCH_CITY = 'New York'
GROUP BY
    C.CUSTOMER_NAME
HAVING
    COUNT(DISTINCT A.IFSC) = (
        SELECT
            COUNT(IFSC)
        FROM
            BRANCH
        WHERE
            BRANCH_CITY = 'New York'
    );

DELETE FROM DEPOSITOR
WHERE ACCNO IN (
    SELECT ACCNO
    FROM ACCOUNT
    WHERE IFSC IN (
        SELECT IFSC
        FROM BRANCH
        WHERE BRANCH_CITY = 'New York'
    )
);

DELETE FROM CUSTOMER
WHERE ACCNO IN (
    SELECT ACCNO
    FROM ACCOUNT
    WHERE IFSC IN (
        SELECT IFSC
        FROM BRANCH
        WHERE BRANCH_CITY = 'New York'
    )
);

DELETE FROM ACCOUNT
WHERE IFSC IN (
    SELECT IFSC
    FROM BRANCH
    WHERE BRANCH_CITY = 'New York'
);

-- DROP TABLE BRANCH CASCADE CONSTRAINTS;
-- DROP TABLE ACCOUNT CASCADE CONSTRAINTS;
-- DROP TABLE DEPOSITOR CASCADE CONSTRAINTS;
-- DROP TABLE CUSTOMER CASCADE CONSTRAINTS;
-- DROP TABLE LOAN CASCADE CONSTRAINTS;
-- DROP TABLE BORROWER CASCADE CONSTRAINTS;
